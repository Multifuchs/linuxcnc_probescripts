%

o<probe_ztop> sub
    (Probes the height of the surface bellow the probe.)
    
    (Parameter with value, which indicates no value)
    #<NULL> = -999999999
    (Remember position, where the routine started.)
    #<startX> = #<_x>
    #<startY> = #<_y>
    #<startZ> = #<_z>
    
    (Read configuration parameters.)
    #<clearanceXY> = #<_ini[PROBETOOL_CLEARANCE]XY>
    #<clearanceZ> = #<_ini[PROBETOOL_CLEARANCE]Z>
    #<slowFeed> = #<_ini[PROBETOOL_FEED]SLOW>
    #<slowBackFeed> = #<_ini[PROBETOOL_FEED]SLOW_BACK>
    #<offXleft> = #<_ini[PROBETOOL_OFFSETS]X_LEFT>
    #<offXright> = #<_ini[PROBETOOL_OFFSETS]X_RIGHT>
    #<offYfront> = #<_ini[PROBETOOL_OFFSETS]Y_FRONT>
    #<offYback> = #<_ini[PROBETOOL_OFFSETS]Y_BACK>
    #<offZbottom> = 0.0
    
    (Z for fast moves is start point plus clearance.)
    (If start Z is above Z-limit, use Z-limit instead.)
    #<fastZ> = #<NULL>
    G28.1 (stores the current absolute position into parameters 5161-5166, 5163 is machine Z)
    O10 if [[#5163 + #<clearanceZ>] GT #<_ini[PROBETOOL_CLEARANCE]AXIS_Z_MAX>]
        (MSG, Use zMaxG53 as max Z Height)
        #<fastZ> = [#<startZ> + [#<_ini[PROBETOOL_CLEARANCE]AXIS_Z_MAX> - #5163]]
    O10 else
        #<fastZ> = [#<startZ> + #<clearanceZ>]
    O10 endif
    (Safety check.)
    O20 if [[#<fastZ> LT #<startZ>] OR [#<fastZ> EQ #<NULL>]]
        (ABORT, Something went wrong with computing fastZ.)
        M2
    O20 endif
    
    (Variables, where the location of the probed point is stored.)
    #<probedX> = #<NULL>
    #<probedY> = #<NULL>
    #<probedZ> = #<NULL>
    
    
    
    G38.2 Z[#<startZ> - 4] F[#<slowFeed>]
    G38.4 Z[#<_z> + 3] F[#<slowBackFeed>]
    #<probedX> = #5061
    #<probedY> = #5062
    #<probedZ> = [#5063 + #<offZbottom>]
    o<fast_move> call [#<_x>] [#<_y>] [#<fastZ>]
    G10 L20 P0 Z[#<fastZ> - #<probedZ>]
o<probe_ztop> endsub

o<fast_move> sub
    O30 if [[[#<_x> NE #1] OR [#<_y> NE #2]] OR [#<_z> NE #3]]
        G38.3 X[#1] Y[#2] Z[#3] F[#<_ini[PROBETOOL_FEED]FAST>]
        O40 if [#5070]
            (ABORT, Probe collision detected.)
            M2
        O40 endif
    O30 endif
o<fast_move> endsub

%