%

o<probe_bore> sub
    (Probes the center of a bore where the probe currently is inside of.)
    (Parameters:)
    (#1: Estimated diameter of the bore.)
    
    (Parameter with value, which indicates no value)
    #<NULL> = -999999999
    (Remember position, where the routine started.)
    #<startX> = #<_x>
    #<startY> = #<_y>
    #<startZ> = #<_z>
    
    (Read configuration parameters.)
    #<clearanceXY> = #<_ini[PROBETOOL_CLEARANCE]XY>
    #<clearanceZ> = #<_ini[PROBETOOL_CLEARANCE]Z>
    #<slowFeed> = #<_ini[PROBETOOL_FEED]SLOW>
    #<slowBackFeed> = #<_ini[PROBETOOL_FEED]SLOW_BACK>
    #<offXleft> = #<_ini[PROBETOOL_OFFSETS]X_LEFT>
    #<offXright> = #<_ini[PROBETOOL_OFFSETS]X_RIGHT>
    #<offYfront> = #<_ini[PROBETOOL_OFFSETS]Y_FRONT>
    #<offYback> = #<_ini[PROBETOOL_OFFSETS]Y_BACK>
    #<offZbottom> = 0.0
    
    (Z for fast moves is start point plus clearance.)
    (If start Z is above Z-limit, use Z-limit instead.)
    #<fastZ> = #<NULL>
    G28.1 (stores the current absolute position into parameters 5161-5166, 5163 is machine Z)
    O10 if [[#5163 + #<clearanceZ>] GT #<_ini[PROBETOOL_CLEARANCE]AXIS_Z_MAX>]
        (MSG, Use zMaxG53 as max Z Height)
        #<fastZ> = [#<startZ> + [#<_ini[PROBETOOL_CLEARANCE]AXIS_Z_MAX> - #5163]]
    O10 else
        #<fastZ> = [#<startZ> + #<clearanceZ>]
    O10 endif
    (Safety check.)
    O20 if [[#<fastZ> LT #<startZ>] OR [#<fastZ> EQ #<NULL>]]
        (ABORT, Something went wrong with computing fastZ.)
        M2
    O20 endif
    
    (Variables, where the location of the probed point is stored.)
    #<probedX> = #<NULL>
    #<probedY> = #<NULL>
    #<probedZ> = #<NULL>
    
    
    
    #<estDiam> = #1
    #<estR> = [#<estDiam> / 2]
    #<fastDist> = [#<estR> - #<clearanceXY>]
    #<doGoFast> = [#<fastDist> GT 10]
    O30 if [#<estDiam> LT 0]
        (ABORT, Estimated diameter _param 1_ must be >= 0)
        M2
    O30 elseif [#<estDiam> EQ 0]
        (MSG, No estimated diameter. All moves are slow af.)
    O30 endif
    #<probeValA> = #<NULL>
    #<probeValB> = #<NULL>
    
    (Probe left)
    O40 if [#<doGoFast>]
        o<fast_move> call [#<startX> - #<fastDist>] [#<_y>] [#<_z>]
    O40 endif
    G38.2 X[#<startX> - [#<estR> + #<clearanceXY>]] F[#<slowFeed>]
    G38.4 X[#<_x> + 3] F[#<slowBackFeed>]
    #<probedX> = [#5061 + #<offXleft>]
    #<probedY> = #5062
    #<probedZ> = #5063
    #<probeValA> = #<probedX>
    o<fast_move> call [#<startX>] [#<startY>] [#<_z>]
    
    (Probe right)
    O50 if [#<doGoFast>]
        o<fast_move> call [#<startX> + #<fastDist>] [#<_y>] [#<_z>]
    O50 endif
    G38.2 X[#<startX> + [#<estR> + #<clearanceXY>]] F[#<slowFeed>]
    G38.4 X[#<_x> - 3] F[#<slowBackFeed>]
    #<probedX> = [#5061 + #<offXright>]
    #<probedY> = #5062
    #<probedZ> = #5063
    #<probeValB> = #<probedX>
    o<fast_move> call [#<startX>] [#<startY>] [#<_z>]
    
    (Update center of axis x)
    #<startX> = [0.5 * [#<probeValA> + #<probeValB>]]
    
    (Probe front)
    O60 if [#<doGoFast>]
        o<fast_move> call [#<_x>] [#<startY> - #<fastDist>] [#<_z>]
    O60 endif
    G38.2 Y[#<startY> - [#<estR> + #<clearanceXY>]] F[#<slowFeed>]
    G38.4 Y[#<_y> + 3] F[#<slowBackFeed>]
    #<probedX> = #5061
    #<probedY> = [#5062 + #<offYfront>]
    #<probedZ> = #5063
    #<probeValA> = #<probedY>
    o<fast_move> call [#<startX>] [#<startY>] [#<_z>]
    
    (Probe back)
    O70 if [#<doGoFast>]
        o<fast_move> call [#<_x>] [#<startY> + #<fastDist>] [#<_z>]
    O70 endif
    G38.2 Y[#<startY> + [#<estR> + #<clearanceXY>]] F[#<slowFeed>]
    G38.4 Y[#<_y> - 3] F[#<slowBackFeed>]
    #<probedX> = #5061
    #<probedY> = [#5062 + #<offYback>]
    #<probedZ> = #5063
    #<probeValB> = #<probedY>
    o<fast_move> call [#<startX>] [#<startY>] [#<_z>]
    
    (Update center of axis y)
    #<startY> = [0.5 * [#<probeValA> + #<probeValB>]]
    
    (Probe left)
    O80 if [#<doGoFast>]
        o<fast_move> call [#<startX> - #<fastDist>] [#<_y>] [#<_z>]
    O80 endif
    G38.2 X[#<startX> - [#<estR> + #<clearanceXY>]] F[#<slowFeed>]
    G38.4 X[#<_x> + 3] F[#<slowBackFeed>]
    #<probedX> = [#5061 + #<offXleft>]
    #<probedY> = #5062
    #<probedZ> = #5063
    #<probeValA> = #<probedX>
    o<fast_move> call [#<startX>] [#<startY>] [#<_z>]
    
    (Probe right)
    O90 if [#<doGoFast>]
        o<fast_move> call [#<startX> + #<fastDist>] [#<_y>] [#<_z>]
    O90 endif
    G38.2 X[#<startX> + [#<estR> + #<clearanceXY>]] F[#<slowFeed>]
    G38.4 X[#<_x> - 3] F[#<slowBackFeed>]
    #<probedX> = [#5061 + #<offXright>]
    #<probedY> = #5062
    #<probedZ> = #5063
    #<probeValB> = #<probedX>
    o<fast_move> call [#<startX>] [#<startY>] [#<_z>]
    
    (Update center of axis x)
    #<startX> = [0.5 * [#<probeValA> + #<probeValB>]]
    
    o<fast_move> call [#<startX>] [#<startY>] [#<_z>]
    G10 L20 P0 X[#<startX>] Y[#<startY>]
    o<fast_move> call [#<_x>] [#<_y>] [#<fastZ>]
o<probe_bore> endsub

o<fast_move> sub
    O100 if [[[#<_x> NE #1] OR [#<_y> NE #2]] OR [#<_z> NE #3]]
        G38.3 X[#1] Y[#2] Z[#3] F[#<_ini[PROBETOOL_FEED]FAST>]
        O110 if [#5070]
            (ABORT, Probe collision detected.)
            M2
        O110 endif
    O100 endif
o<fast_move> endsub

%