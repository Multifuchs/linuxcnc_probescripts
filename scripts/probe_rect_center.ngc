%

o<probe_rect_center> sub
    (Parameters:)
    (#1: Estimated width _X_)
    (#2: Estimated depth _Y_)
    (#3: Startpoint _0=Center_default_, 1: Left-front corner_)
    (#4: How much the probe should be bellow the top-surface, when probing sides. _default: 3mm_)
    
    (Parameter with value, which indicates no value)
    #<NULL> = -999999999
    (Remember position, where the routine started.)
    #<startX> = #<_x>
    #<startY> = #<_y>
    #<startZ> = #<_z>
    
    (Read configuration parameters.)
    #<clearanceXY> = #<_ini[PROBETOOL_CLEARANCE]XY>
    #<clearanceZ> = #<_ini[PROBETOOL_CLEARANCE]Z>
    #<slowFeed> = #<_ini[PROBETOOL_FEED]SLOW>
    #<slowBackFeed> = #<_ini[PROBETOOL_FEED]SLOW_BACK>
    #<offXleft> = #<_ini[PROBETOOL_OFFSETS]X_LEFT>
    #<offXright> = #<_ini[PROBETOOL_OFFSETS]X_RIGHT>
    #<offYfront> = #<_ini[PROBETOOL_OFFSETS]Y_FRONT>
    #<offYback> = #<_ini[PROBETOOL_OFFSETS]Y_BACK>
    #<offZbottom> = 0.0
    
    (Z for fast moves is start point plus clearance.)
    (If start Z is above Z-limit, use Z-limit instead.)
    #<fastZ> = #<NULL>
    G28.1 (stores the current absolute position into parameters 5161-5166, 5163 is machine Z)
    O10 if [[#5163 + #<clearanceZ>] GT #<_ini[PROBETOOL_CLEARANCE]AXIS_Z_MAX>]
        (MSG, Use zMaxG53 as max Z Height)
        #<fastZ> = [#<startZ> + [#<_ini[PROBETOOL_CLEARANCE]AXIS_Z_MAX> - #5163]]
    O10 else
        #<fastZ> = [#<startZ> + #<clearanceZ>]
    O10 endif
    (Safety check.)
    O20 if [[#<fastZ> LT #<startZ>] OR [#<fastZ> EQ #<NULL>]]
        (ABORT, Something went wrong with computing fastZ.)
        M2
    O20 endif
    
    (Variables, where the location of the probed point is stored.)
    #<probedX> = #<NULL>
    #<probedY> = #<NULL>
    #<probedZ> = #<NULL>
    
    
    
    (estXXX: Estimated value, depending on position when starting the routine and its params.)
    #<estWidth> = #1
    #<estDepth> = #2
    #<start> = #3
    #<estCenterX> = #<startX>
    #<estCenterY> = #<startY>
    #<sideZOff> = #4
    O30 if [#<estWidth> LT 1]
        (ABORT, Estimated width _param #1_ is too small.)
        M2
    O30 elseif [#<estDepth> LT 1]
        (ABORT, Estimated depth _param #2_ is too small.)
        M2
    O30 endif
    O40 if [#<start> EQ 0]
        (MSG, Probe rectangle starting from its estimated center.)
    O40 elseif [#<start> EQ 1]
        (MSG, Probe rectangle starting from its estimated left-front corner.)
        #<estCenterX> = [#<estCenterX> + [#<estWidth> / 2]]
        #<estCenterY> = [#<estCenterY> + [#<estDepth> / 2]]
    O40 else
        (ABORT, Param #3 must be 0 _center_ or 1 _Left-front-corner_.)
        M2
    O40 endif
    O50 if [#<sideZOff> EQ 0]
        #<sideZOff> = 3
    O50 elseif [#<sideZOff> LT 0]
        (ABORT, Param #3 must be >= 0.)
        M2
    O50 endif
    
    (Variables for results.)
    #<probedTop> = #<startZ>
    #<probedLeft> = #<startX>
    #<probedRight> = #<startX>
    #<probedFront> = #<startY>
    #<probedBack> = #<startY>
    
    O60 if [#<start> NE 0]
        o<fast_move> call [#<_x>] [#<_y>] [#<fastZ>]
    O60 else
        (Probe top surface only if starting point is center.)
        G38.2 Z[#<startZ> - #<clearanceZ>] F[#<slowFeed>]
        G38.4 Z[#<_z> + 3] F[#<slowBackFeed>]
        #<probedX> = #5061
        #<probedY> = #5062
        #<probedZ> = [#5063 + #<offZbottom>]
        #<probedTop> = #<probedZ>
        o<fast_move> call [#<_x>] [#<_y>] [#<fastZ>]
    O60 endif
    
    (Probe left side)
    o<fast_move> call [#<estCenterX> + [-1 * [[#<estWidth> / 2] + #<clearanceXY>]]] [#<_y>] [#<_z>]
    o<fast_move> call [#<_x>] [#<_y>] [#<probedTop> - #<sideZOff>]
    G38.2 X[#<estCenterX> + [-1 * [[#<estWidth> / 2] - #<clearanceXY>]]] F[#<slowFeed>]
    G38.4 X[#<_x> - 3] F[#<slowBackFeed>]
    #<probedX> = [#5061 + #<offXright>]
    #<probedY> = #5062
    #<probedZ> = #5063
    #<probedLeft> = #<probedX>
    o<fast_move> call [#<estCenterX> + [-1 * [[#<estWidth> / 2] + #<clearanceXY>]]] [#<_y>] [#<_z>]
    o<fast_move> call [#<_x>] [#<_y>] [#<fastZ>]
    o<fast_move> call [#<estCenterX>] [#<estCenterY>] [#<_z>]
    
    (Probe right side)
    o<fast_move> call [#<estCenterX> + [[#<estWidth> / 2] + #<clearanceXY>]] [#<_y>] [#<_z>]
    o<fast_move> call [#<_x>] [#<_y>] [#<probedTop> - #<sideZOff>]
    G38.2 X[#<estCenterX> + [[#<estWidth> / 2] - #<clearanceXY>]] F[#<slowFeed>]
    G38.4 X[#<_x> + 3] F[#<slowBackFeed>]
    #<probedX> = [#5061 + #<offXleft>]
    #<probedY> = #5062
    #<probedZ> = #5063
    #<probedRight> = #<probedX>
    o<fast_move> call [#<estCenterX> + [[#<estWidth> / 2] + #<clearanceXY>]] [#<_y>] [#<_z>]
    o<fast_move> call [#<_x>] [#<_y>] [#<fastZ>]
    o<fast_move> call [#<estCenterX>] [#<estCenterY>] [#<_z>]
    
    (Probe front side)
    o<fast_move> call [#<_x>] [#<estCenterY> + [-1 * [[#<estDepth> / 2] + #<clearanceXY>]]] [#<_z>]
    o<fast_move> call [#<_x>] [#<_y>] [#<probedTop> - #<sideZOff>]
    G38.2 Y[#<estCenterY> + [-1 * [[#<estDepth> / 2] - #<clearanceXY>]]] F[#<slowFeed>]
    G38.4 Y[#<_y> - 3] F[#<slowBackFeed>]
    #<probedX> = #5061
    #<probedY> = [#5062 + #<offYback>]
    #<probedZ> = #5063
    #<probedFront> = #<probedY>
    o<fast_move> call [#<_x>] [#<estCenterY> + [-1 * [[#<estDepth> / 2] + #<clearanceXY>]]] [#<_z>]
    o<fast_move> call [#<_x>] [#<_y>] [#<fastZ>]
    o<fast_move> call [#<estCenterX>] [#<estCenterY>] [#<_z>]
    
    (Probe back side)
    o<fast_move> call [#<_x>] [#<estCenterY> + [[#<estDepth> / 2] + #<clearanceXY>]] [#<_z>]
    o<fast_move> call [#<_x>] [#<_y>] [#<probedTop> - #<sideZOff>]
    G38.2 Y[#<estCenterY> + [[#<estDepth> / 2] - #<clearanceXY>]] F[#<slowFeed>]
    G38.4 Y[#<_y> + 3] F[#<slowBackFeed>]
    #<probedX> = #5061
    #<probedY> = [#5062 + #<offYfront>]
    #<probedZ> = #5063
    #<probedBack> = #<probedY>
    o<fast_move> call [#<_x>] [#<estCenterY> + [[#<estDepth> / 2] + #<clearanceXY>]] [#<_z>]
    o<fast_move> call [#<_x>] [#<_y>] [#<fastZ>]
    o<fast_move> call [#<estCenterX>] [#<estCenterY>] [#<_z>]
    
    (Compute center.)
    #<centerX> = [0.5 * [#<probedLeft> + #<probedRight>]]
    #<centerY> = [0.5 * [#<probedFront> + #<probedBack>]]
    #<width> = ABS[#<probedRight> - #<probedLeft>]
    #<depth> = ABS[#<probedBack> - #<probedFront>]
    G10 L20 P0 X[#<estCenterX> - #<centerX>] Y[[#<estCenterY> - #<centerY>]] Z[#<fastZ> - #<probedTop>]
    (debug, W:  #<width> , D:  #<depth>)
o<probe_rect_center> endsub

o<fast_move> sub
    o<fast_move> sub
        O70 if [[[#<_x> NE #1] OR [#<_y> NE #2]] OR [#<_z> NE #3]]
            G38.3 X[#1] Y[#2] Z[#3] F[#<_ini[PROBETOOL_FEED]FAST>]
            O80 if [#5070]
                (ABORT, Probe collision detected.)
                M2
            O80 endif
        O70 endif
    o<fast_move> endsub
o<fast_move> endsub

%